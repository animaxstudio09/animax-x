<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANIMAX PREMIUM</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "fdac3928-a2fc-4bc7-9541-cb85ae026409",
        });
      });
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { 
            --gold: #D4AF37; 
            --dark-gold: #AA8C2C;
            --black: #050505; 
            --glass: rgba(20, 20, 20, 0.95);
            --border: 1px solid rgba(212, 175, 55, 0.3);
            --neon-glow: 0 0 12px rgba(212, 175, 55, 0.4);
            --red: #ff3b3b;
            --green-accent: #00b894;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Outfit', sans-serif; background: #000; color: #fff; overflow-x: hidden; padding-bottom: 70px; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- Auth Screen --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 10000;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box {
            background: rgba(255, 255, 255, 0.03); padding: 40px 30px; border-radius: 20px; width: 100%; max-width: 350px;
            text-align: center; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 40px rgba(0,0,0,0.8); animation: fadeIn 0.6s ease-out;
        }
        .auth-box h2 { font-family: 'Orbitron'; font-size: 28px; color: #fff; margin-bottom: 30px; letter-spacing: 2px; }
        .auth-box h2 span { color: var(--gold); text-shadow: var(--neon-glow); }
        
        input { 
            width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; 
            border: 1px solid #333; background: rgba(0,0,0,0.5); color: #fff; 
            font-family: 'Outfit'; text-align: center; transition: 0.3s;
        }
        input:focus { border-color: var(--gold); box-shadow: var(--neon-glow); }

        .btn-royal {
            width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700;
            background: linear-gradient(45deg, var(--dark-gold), var(--gold)); color: #000;
            font-family: 'Orbitron'; cursor: pointer; letter-spacing: 1px; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .btn-royal:active { transform: scale(0.98); }

        /* --- Main UI Structure --- */
        .app-view { display: none; padding-top: 60px; animation: fadeIn 0.4s; }
        
        header { 
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(0,0,0,0.9); position: fixed; top: 0; left: 0; right: 0; z-index: 100; border-bottom: var(--border); 
            backdrop-filter: blur(10px);
        }
        .logo { font-family: 'Orbitron'; font-weight: 900; font-size: 20px; letter-spacing: 1px; }
        .logo span { color: var(--gold); }

        /* Slider */
        #banner-slider, #movie-banner-slider { 
            width: calc(100% - 30px); height: 180px; margin: 15px auto; border-radius: 15px; 
            overflow: hidden; position: relative; border: var(--border); box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .slide { position: absolute; inset: 0; opacity: 0; transition: 1s; background-size: cover; background-position: center; }
        .slide.active { opacity: 1; }

        /* Section Title */
        .section-title {
            padding: 0 15px; margin-top: 25px; margin-bottom: 15px;
            font-family: 'Orbitron'; color: var(--gold); letter-spacing: 1px; font-size: 14px; 
            display:flex; align-items:center; justify-content: space-between;
        }

        /* GRID 4 SYSTEM */
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 0 10px; }
        .folder-card { 
            position: relative; border-radius: 8px; overflow: hidden; background: #111; 
            border: 1px solid #222; aspect-ratio: 2/3; transition: 0.2s;
        }
        .folder-card:active { transform: scale(0.95); }
        .folder-card img { width: 100%; height: 100%; object-fit: cover; }
        .folder-info { 
            position: absolute; bottom: 0; width: 100%; padding: 5px; 
            background: linear-gradient(to top, #000 10%, transparent); text-align: center; 
        }
        .folder-title { font-size: 9px; font-family: 'Orbitron'; color: #fff; text-shadow: 0 1px 3px #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Movie Box Specifics --- */
        #movie-box-view { background: #0a0a0a; min-height: 100vh; }
        .movie-header { background: #1a0505; border-bottom: 1px solid #ff3b3b; }
        .movie-header .logo span { color: #ff3b3b; }
        
        /* --- Shorts --- */
        #shorts-view { 
            position: fixed; inset: 0; background: #000; z-index: 200; 
            padding: 0; overflow-y: scroll; scroll-snap-type: y mandatory; 
        }
        .short-item {
            width: 100%; height: 100vh; scroll-snap-align: start; position: relative;
            background: #111; display: flex; align-items: center; justify-content: center;
        }
        .short-item video { width: 100%; height: 100%; object-fit: cover; }
        .short-overlay {
            position: absolute; bottom: 80px; right: 10px; display: flex; flex-direction: column; gap: 20px; z-index: 10;
        }
        .short-btn { color: #fff; text-align: center; font-size: 24px; text-shadow: 0 2px 5px #000; cursor: pointer; }
        .short-btn.liked { color: var(--red); }
        .short-btn span { display: block; font-size: 10px; font-family: 'Orbitron'; margin-top: 5px; }

        /* Shorts Comment Modal */
        #shorts-comments-modal {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 60%;
            background: #111; border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 250; padding: 15px; border-top: 2px solid var(--gold);
            animation: slideUp 0.3s ease-out; box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- NEW PLAYER UI DESIGN (SCREENSHOT STYLE) --- */
        #player-view { 
            position: fixed; inset: 0; background: #000; z-index: 5000; overflow-y: auto; display: none; 
        }
        .video-wrapper { position: sticky; top: 0; z-index: 5001; background: #000; width: 100%; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; }

        /* Meta Container */
        .player-meta-container { padding: 15px; background: #050505; min-height: 100vh; }
        
        .meta-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .meta-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 5px; font-family: 'Outfit', sans-serif; line-height: 1.2; }
        
        .meta-info { font-size: 11px; color: #aaa; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .rating-star { color: #ffb400; font-size: 10px; }

        /* Action Buttons */
        .action-buttons-row { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .action-buttons-row::-webkit-scrollbar { display: none; }
        
        .act-btn { 
            background: #1e1e1e; color: #fff; border: 1px solid #333; 
            padding: 10px 16px; border-radius: 8px; font-size: 12px; 
            display: flex; align-items: center; gap: 6px; white-space: nowrap; cursor: pointer; transition: 0.2s;
        }
        .act-btn:active { transform: scale(0.95); background: #333; }
        .act-btn i { font-size: 14px; }
        .act-btn.liked { color: var(--red); border-color: var(--red); background: rgba(255, 59, 59, 0.1); }

        /* Resources / Season Dropdowns */
        .resources-section { margin-bottom: 25px; }
        .res-title { font-size: 13px; color: #fff; margin-bottom: 12px; font-weight: 600; }
        .res-title span { color: #888; font-size: 11px; font-weight: 400; margin-left: 5px; }
        
        .dropdown-row { display: flex; gap: 10px; margin-bottom: 15px; }
        
        /* Styled Select for Season */
        select.custom-drop {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: #1e1e1e;
            color: #ddd;
            border: 1px solid #333;
            padding: 8px 14px;
            padding-right: 30px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            outline: none;
        }
        .custom-drop-label {
            background: #1e1e1e; color: #ddd; border: 1px solid #333; 
            padding: 8px 14px; border-radius: 6px; font-size: 12px; 
            display: flex; align-items: center; gap: 8px; cursor: pointer;
        }

        /* Episode Pills */
        .ep-pill-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .ep-pill-row::-webkit-scrollbar { display: none; }
        
        .ep-pill { 
            min-width: 45px; height: 40px; background: #111; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 13px; color: #aaa; border: 1px solid #2a2a2a; flex-shrink: 0; cursor: pointer;
        }
        .ep-pill.active { background: var(--green-accent); color: #fff; border-color: var(--green-accent); font-weight: 700; box-shadow: 0 2px 10px rgba(0, 184, 148, 0.3); } 

        /* Tabs (For You / Comments) */
        .tab-header { display: flex; gap: 25px; border-bottom: 1px solid #222; margin-bottom: 20px; }
        .tab-item { padding-bottom: 10px; font-size: 14px; color: #888; position: relative; cursor: pointer; font-weight: 500; }
        .tab-item.active { color: #fff; font-weight: 700; }
        .tab-item.active::after { content:''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: #fff; }

        /* Vertical Recommendation Grid */
        .rec-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px; }
        .rec-card { position: relative; aspect-ratio: 2/3; border-radius: 8px; overflow: hidden; background: #111; }
        .rec-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .rec-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: #fff; font-size: 9px; padding: 2px 5px; border-radius: 4px; }
        .rec-title { position: absolute; bottom: 0; width: 100%; padding: 8px 5px; background: linear-gradient(to top, #000, transparent); font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }

        /* BuzzBox Preview at Bottom */
        .buzz-preview { background: #111; border-radius: 12px; padding: 15px; margin-top: 20px; border: 1px solid #222; cursor: pointer; }
        .buzz-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 12px; align-items: center; }
        .buzz-imgs { display: flex; gap: 8px; overflow: hidden; height: 90px; }
        .buzz-img { width: 32%; border-radius: 6px; object-fit: cover; opacity: 0.7; }
        .buzz-play { width: 32%; background:#1a1a1a; border-radius:6px; display:flex; align-items:center; justify-content:center; border:1px solid #333; }

        /* Comments in Player */
        .comment-section { padding: 0; margin-bottom: 50px; }
        .comment-box { display: flex; margin-bottom: 15px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #222; }
        .c-avatar { width: 30px; height: 30px; background: #333; border-radius: 50%; margin-right: 10px; color: var(--gold); display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .c-body h4 { font-size: 12px; color: var(--gold); margin-bottom: 3px; }
        .c-body p { font-size: 11px; color: #ccc; }

        /* --- Navigation --- */
        nav { 
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; 
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(15px); border-radius: 25px; 
            padding: 12px; display: flex; justify-content: space-around; border: 1px solid #333; z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        }
        nav i { font-size: 20px; color: #555; transition: 0.3s; padding: 10px; border-radius: 50%; }
        nav i.active { color: #000; background: var(--gold); box-shadow: var(--neon-glow); }

        /* --- Footer --- */
        .dev-footer {
            text-align: center; padding: 20px; margin-top: 30px; border-top: 1px solid #222;
            font-family: 'Orbitron'; font-size: 10px; color: #444;
        }
        
        /* AD Container */
        .ad-container-center {
            display: flex; justify-content: center; align-items: center;
            margin: 15px 0; overflow: hidden; width: 100%; min-height: 1px;
        }

        /* --- History Modal --- */
        #history-view {
            display:none; position:fixed; inset:0; background:#000; z-index:6000; overflow-y:auto; padding:20px;
            animation: fadeIn 0.3s;
        }
        .history-item {
            background: #111; padding: 15px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #222;
            display: flex; justify-content: space-between; align-items: center;
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box" id="login-form">
            <h2>ANIMAX <span>PREMIUM</span></h2>
            <input type="email" id="email-in" placeholder="Email Address">
            <input type="password" id="pass-in" placeholder="Password">
            <button class="btn-royal" onclick="handleAuth('login')">LOGIN</button>
            <p style="margin-top:20px; font-size:11px; color:#888; cursor: pointer;" onclick="toggleAuth()">Create New Account</p>
        </div>
        <div class="auth-box" id="reg-form" style="display:none;">
            <h2>JOIN <span>ROYAL</span></h2>
            <input type="email" id="remail-in" placeholder="Valid Email">
            <input type="password" id="rpass-in" placeholder="Strong Password">
            <button class="btn-royal" onclick="handleAuth('reg')">REGISTER</button>
            <p style="margin-top:20px; font-size:11px; color:#888; cursor: pointer;" onclick="toggleAuth()">Back to Login</p>
        </div>
    </div>

    <div id="main-app" class="app-view">
        <header>
            <div class="logo">ANIMAX <span>PREMIUM</span></div>
            <i class="fas fa-search" style="color:#fff; font-size:18px;"></i>
        </header>

        <div id="banner-slider"></div>

        <div id="ad-banner-top" class="ad-container-center"></div>
        
        <div class="section-title">
            <span><i class="fas fa-bolt" style="color:var(--gold)"></i> NEW RELEASE</span>
            <span style="font-size:10px; color:#666">See All</span>
        </div>

        <div id="anime-grid" class="grid-container"></div>

        <div class="dev-footer">Developed by RJ Rocky</div>
    </div>

    <div id="movie-box-view" class="app-view">
        <header class="movie-header">
            <div class="logo">MOVIE <span>BOX</span></div>
            <i class="fas fa-sign-out-alt" style="color:#fff;" onclick="switchInterface('main')"></i>
        </header>

        <div id="movie-banner-slider"></div>

        <div class="section-title">
            <span style="color:#ff3b3b"><i class="fas fa-film"></i> TRENDING MOVIES</span>
        </div>

        <div id="movie-grid" class="grid-container"></div>
    </div>

    <div id="shorts-view" style="display:none;">
        <div style="position:fixed; top:20px; left:20px; z-index:101; color:#fff;" onclick="hideShorts()">
            <i class="fas fa-arrow-left" style="background:rgba(0,0,0,0.5); padding:10px; border-radius:50%;"></i>
        </div>
        <div id="shorts-container"></div>
        
        <div id="shorts-comments-modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <span style="font-family:'Orbitron'; color:var(--gold);">COMMENTS</span>
                <i class="fas fa-times" onclick="document.getElementById('shorts-comments-modal').style.display='none'"></i>
            </div>
            <div id="shorts-comments-list" style="height: calc(100% - 100px); overflow-y:auto; margin-bottom:10px;"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="short-comment-in" placeholder="Write a comment..." style="margin-bottom:0;">
                <button class="btn-royal" style="width:50px; margin-top:0;" onclick="postShortComment()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="player-view">
        <div class="video-wrapper">
            <div style="position:absolute; top:15px; left:15px; z-index:10;" onclick="closePlayer()">
                <i class="fas fa-arrow-left" style="font-size:18px; color:#fff; background:rgba(0,0,0,0.6); padding:10px; border-radius:50%;"></i>
            </div>
            <video id="main-video" controls playsinline></video>
        </div>

        <div class="player-meta-container">
            
            <div class="meta-header">
                <div>
                    <div class="meta-title" id="player-title">Episode Title</div>
                    <div class="meta-info">
                        <i class="fas fa-tv"></i>
                        <span><i class="fas fa-star rating-star"></i> 8.5</span>
                        <span>| 2024</span>
                        <span>| Japan</span>
                        <span>| Anime</span>
                        <span id="view-count" style="display:none">0</span>
                        <span id="like-count" style="display:none">0</span>
                    </div>
                </div>
                <i class="fas fa-chevron-right" style="color:#666; margin-top: 5px;"></i>
            </div>

            <div class="action-buttons-row">
                <div class="act-btn" id="like-btn" onclick="toggleLike()">
                    <i class="fas fa-plus"></i> Add to list
                </div>
                <div class="act-btn" onclick="shareContent()">
                    <i class="fas fa-share-alt"></i> Share
                </div>
                <div class="act-btn">
                    <i class="fas fa-download"></i> Download
                </div>
                <div class="act-btn" style="border:1px solid #444;">
                    <i class="fas fa-info-circle"></i> Details
                </div>
            </div>

            <div class="resources-section">
                <div class="res-title">Resources <span>Uploaded by Admin etc.</span> <i class="far fa-question-circle" style="font-size:10px; color:#666;"></i></div>
                <div class="dropdown-row">
                    <div class="custom-drop-label">Hindi dub <i class="fas fa-chevron-down"></i></div>
                    
                    <select id="season-select" onchange="switchSeason(this.value)" class="custom-drop">
                        </select>
                </div>

                <div class="ep-pill-row" id="episode-pill-container">
                    </div>
            </div>

            <div class="tab-header">
                <div class="tab-item active">For you</div>
                <div class="tab-item" onclick="document.querySelector('.comment-section').scrollIntoView({behavior:'smooth'})">Comments(99+)</div>
            </div>

            <div class="rec-grid">
                <div class="rec-card">
                    <img src="https://c4.wallpaperflare.com/wallpaper/935/563/66/anime-demon-slayer-kimetsu-no-yaiba-tanjirou-kamado-hd-wallpaper-preview.jpg">
                    <div class="rec-badge">Hindi</div>
                    <div class="rec-title">Demon Slayer</div>
                </div>
                <div class="rec-card">
                    <img src="https://c4.wallpaperflare.com/wallpaper/237/264/677/solo-leveling-sung-jin-woo-anime-boys-anime-wallpaper-preview.jpg">
                    <div class="rec-badge">Hindi</div>
                    <div class="rec-title">Solo Leveling</div>
                </div>
                <div class="rec-card">
                    <img src="https://c4.wallpaperflare.com/wallpaper/52/569/531/anime-spy-x-family-anya-forger-hd-wallpaper-preview.jpg">
                    <div class="rec-badge">Sub</div>
                    <div class="rec-title">Spy x Family</div>
                </div>
            </div>

            <div class="buzz-preview" onclick="showShorts()">
                <div class="buzz-header">
                    <span><b>BuzzBox</b> - Short & Funny</span>
                    <span style="color:var(--green-accent)">Explore ></span>
                </div>
                <div class="buzz-imgs">
                    <img src="https://via.placeholder.com/150/111/555?text=S1" class="buzz-img">
                    <img src="https://via.placeholder.com/150/111/555?text=S2" class="buzz-img">
                    <div class="buzz-play">
                        <i class="fas fa-play" style="color:#fff"></i>
                    </div>
                </div>
            </div>

            <div id="ad-banner-player" class="ad-container-center" style="margin-top:20px;"></div>

            <div class="comment-section">
                <div style="display:flex; gap:10px; margin-bottom:20px; margin-top:20px;">
                    <input type="text" id="comment-input" placeholder="Add a comment..." style="margin-bottom:0; background:#1e1e1e; border:none;">
                    <button class="btn-royal" style="width:60px; margin-top:0;" onclick="postComment()"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div id="comments-list"></div>
            </div>

        </div>
    </div>

    <div id="profile-view" class="app-view" style="background:#050505; height:100vh; overflow-y:auto;">
        <div style="height:150px; background:url('https://c4.wallpaperflare.com/wallpaper/295/163/719/anime-anime-boys-picture-in-picture-kimetsu-no-yaiba-kamado-tanjir%C5%8D-hd-wallpaper-preview.jpg') center/cover; position:relative;">
            <div style="position:absolute; bottom:-40px; left:50%; transform:translateX(-50%); width:100px; height:100px; border-radius:50%; border:3px solid var(--gold); background:#000; overflow:hidden;">
                <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" style="width:100%; height:100%;">
            </div>
        </div>
        
        <div style="text-align:center; margin-top:50px;">
            <h2 id="profile-name" style="font-family:'Orbitron';">USER</h2>
            <div id="vip-badge" style="display:inline-block; padding:5px 15px; border:1px solid #333; border-radius:20px; font-size:10px; margin-top:5px; color:#666;">FREE ACCOUNT</div>
        </div>

        <div style="padding:20px;">
            <button class="btn-royal" style="background:linear-gradient(45deg, #ff3b3b, #800000); color:#fff; margin-bottom:15px;" onclick="switchInterface('movie')">
                <i class="fas fa-film"></i> MOVIE BOX SWITCH
            </button>

            <div style="background:#111; padding:15px; border-radius:10px; border:1px solid #222; margin-bottom:15px;">
                <h4 style="color:var(--gold); font-family:'Orbitron'; font-size:12px; margin-bottom:10px;"><i class="fas fa-lock"></i> VIP LOCKER</h4>
                <input type="password" id="locker-pin" placeholder="Set/Enter PIN" style="margin-bottom:5px;">
                <button style="width:100%; background:#222; border:none; color:#fff; padding:8px; border-radius:5px;" onclick="alert('Locker Feature Coming Soon!')">ACCESS</button>
            </div>

            <button class="btn-royal" style="background:#1a1a1a; border:1px solid #333; color:#ccc; margin-bottom:20px;" onclick="openHistory()">
                <i class="fas fa-history"></i> VIEW WATCH HISTORY
            </button>

            <div style="background:linear-gradient(45deg, #111, #220000); padding:15px; border-radius:10px; border:1px solid var(--gold);">
                <h4 style="color:var(--gold); font-family:'Orbitron'; margin-bottom:10px;">PREMIUM ACCESS</h4>
                <input type="text" id="prem-code" placeholder="Enter License Code">
                <button class="btn-royal" onclick="redeemCode()">REDEEM CODE</button>
                <button class="btn-royal" style="background:#0088cc; color:#fff; margin-top:5px;" onclick="buyPremium()">
                    <i class="fab fa-telegram"></i> BUY PREMIUM
                </button>
            </div>

            <button onclick="auth.signOut()" style="width:100%; background:#333; border:none; color:#fff; padding:15px; margin-top:20px; border-radius:10px;">LOGOUT</button>
        </div>
    </div>

    <div id="history-view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #333;">
            <h2 style="font-family:'Orbitron'; color:var(--gold);">WATCH HISTORY</h2>
            <i class="fas fa-times" style="font-size:24px; color:#fff;" onclick="closeHistory()"></i>
        </div>
        <div id="history-list-container"></div>
    </div>

    <nav id="main-nav">
        <i class="fas fa-home active" onclick="switchTab('home')"></i>
        <i class="fas fa-play-circle" onclick="showShorts()"></i>
        <i class="fas fa-user" onclick="switchTab('profile')"></i>
    </nav>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcWE5TCxamMSnJxqSm5X4mgSwSccIXcBI",
            authDomain: "myanimeapp-8d079.firebaseapp.com",
            databaseURL: "https://myanimeapp-8d079-default-rtdb.firebaseio.com",
            projectId: "myanimeapp-8d079",
            storageBucket: "myanimeapp-8d079.firebasestorage.app",
            messagingSenderId: "37482342893",
            appId: "1:37482342893:web:bebc7352e4bc102b725fe4"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database();

        let currentUser = null, isPremium = false, currentVideoId = null;
        let adSessionClick = false; 
        let adsLoaded = false; 

        // Listener References
        let currentLikesCountRef = null;
        let currentUserLikeRef = null;
        let currentViewsRef = null;
        let currentCommentsRef = null;

        // --- AUTH SYSTEM ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('profile-name').innerText = user.email.split('@')[0].toUpperCase();
                
                checkPremium(user.uid);
                loadContent();
                // History is now loaded on click
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
                currentUser = null;
            }
        });

        // --- AD SYSTEM ---
        function loadFreeUserAds() {
            if(adsLoaded) return; 
            adsLoaded = true;

            let s1 = document.createElement('script');
            s1.src = "https://pl28670634.effectivegatecpm.com/2f/28/1a/2f281ac58d64e6a580eb2d4171fe33d7.js";
            document.body.appendChild(s1);

            let s2 = document.createElement('script');
            s2.src = "https://pl28670723.effectivegatecpm.com/66/84/a1/6684a1bcf20a187f5844b6e689ba4482.js";
            document.body.appendChild(s2);

            const bannerTop = document.getElementById('ad-banner-top');
            if(bannerTop) {
                bannerTop.innerHTML = `
                    <iframe src="javascript:false" title="" scrolling="no" frameborder="0" 
                    style="border:none; width:320px; height:50px; overflow:hidden;" 
                    srcdoc='<script>atOptions = { "key" : "9f634c6894bc13ff8f0f19de1fcac9f3", "format" : "iframe", "height" : 50, "width" : 320, "params" : {} };<\/script><script src="https://www.highperformanceformat.com/9f634c6894bc13ff8f0f19de1fcac9f3/invoke.js"><\/script>'></iframe>
                `;
            }

            const bannerPlayer = document.getElementById('ad-banner-player');
            if(bannerPlayer) {
                bannerPlayer.innerHTML = `
                    <iframe src="javascript:false" title="" scrolling="no" frameborder="0" 
                    style="border:none; width:468px; height:60px; overflow:hidden;" 
                    srcdoc='<script>atOptions = { "key" : "3c0655cdf72da98fdd68dcdd704f9766", "format" : "iframe", "height" : 60, "width" : 468, "params" : {} };<\/script><script src="https://www.highperformanceformat.com/3c0655cdf72da98fdd68dcdd704f9766/invoke.js"><\/script>'></iframe>
                `;
            }
        }

        function triggerSmartLink() {
            if(isPremium) return;
            if(!adSessionClick) {
                window.open("https://www.effectivegatecpm.com/e3t9unhgv?key=2723dc497461b7507ba151e88ee0e871", "_blank");
                adSessionClick = true; 
            }
        }

        // --- PREMIUM CHECKER ---
        function checkPremium(uid) {
            db.ref(`users/${uid}`).on('value', s => {
                const d = s.val();
                if(d && d.premiumExpiry > Date.now()) {
                    isPremium = true;
                    document.getElementById('vip-badge').innerText = "ROYAL VIP MEMBER ðŸ‘‘";
                    document.getElementById('vip-badge').style.borderColor = "var(--gold)";
                    document.getElementById('vip-badge').style.color = "var(--gold)";
                    document.getElementById('ad-banner-top').style.display = 'none';
                    document.getElementById('ad-banner-player').style.display = 'none';
                } else {
                    isPremium = false;
                    document.getElementById('vip-badge').innerText = "FREE ACCOUNT";
                    document.getElementById('vip-badge').style.borderColor = "#333";
                    document.getElementById('vip-badge').style.color = "#666";
                    document.getElementById('ad-banner-top').style.display = 'flex';
                    document.getElementById('ad-banner-player').style.display = 'flex';
                    loadFreeUserAds();
                }
            });
        }

        function handleAuth(type) {
            const e = document.getElementById(type === 'login' ? 'email-in' : 'remail-in').value;
            const p = document.getElementById(type === 'login' ? 'pass-in' : 'rpass-in').value;
            if (type === 'login') auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
            else auth.createUserWithEmailAndPassword(e, p).catch(err => alert(err.message));
        }
        function toggleAuth() {
            const l = document.getElementById('login-form'), r = document.getElementById('reg-form');
            l.style.display = l.style.display === 'none' ? 'block' : 'none';
            r.style.display = r.style.display === 'none' ? 'block' : 'none';
        }

        // --- NAVIGATION & UI ---
        function switchTab(tab) {
            document.querySelectorAll('.app-view').forEach(d => d.style.display = 'none');
            hideShorts();
            
            if (tab === 'home') document.getElementById('main-app').style.display = 'block';
            if (tab === 'profile') document.getElementById('profile-view').style.display = 'block';
            
            document.querySelectorAll('nav i').forEach(i => i.classList.remove('active'));
            if(tab === 'home') document.querySelector('.fa-home').classList.add('active');
            if(tab === 'profile') document.querySelector('.fa-user').classList.add('active');
        }

        function switchInterface(to) {
            document.querySelectorAll('.app-view').forEach(d => d.style.display = 'none');
            if(to === 'movie') {
                document.getElementById('movie-box-view').style.display = 'block';
                document.getElementById('main-nav').style.display = 'none';
                loadMovies();
            } else {
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('main-nav').style.display = 'flex';
            }
        }

        // --- DATA LOADING ---
        function loadContent() {
            db.ref('banners').on('value', s => {
                const c = document.getElementById('banner-slider'); c.innerHTML = "";
                let i=0; s.forEach(b => { c.innerHTML += `<div class="slide ${i++===0?'active':''}" style="background-image:url('${b.val().image}')"></div>`; });
                startSlider('banner-slider');
            });

            db.ref('anime').on('value', snap => {
                const grid = document.getElementById('anime-grid'); grid.innerHTML = "";
                let folders = {};
                snap.forEach(c => {
                    let d = c.val(), f = d.folder || 'Misc';
                    if(!folders[f]) folders[f] = [];
                    folders[f].push(d);
                });
                
                Object.keys(folders).forEach(name => {
                    let thumb = folders[name][0].thumbnail;
                    grid.innerHTML += `
                        <div class="folder-card" onclick="openFolder('${name.replace(/'/g, "\\'")}')">
                            <img src="${thumb}">
                            <div class="folder-info"><div class="folder-title">${name}</div></div>
                        </div>`;
                });
                window.animeData = folders;
            });
        }

        // --- NEW FOLDER OPEN LOGIC (Direct Play & Player UI) ---
        function openFolder(name) {
            currentFolder = name; // Save state
            const episodes = window.animeData[name];
            
            if(!episodes || episodes.length === 0) return;

            // Auto-play first episode
            const firstEp = episodes[0];
            let epId = firstEp.id ? firstEp.id : firstEp.title.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Open player at index 0
            playVideo(firstEp.title, firstEp.url, epId, firstEp.type === 'premium', 0);
            
            // Load UI elements (Season Dropdown & Episode Pills)
            loadPlayerUI(name);
        }

        function loadPlayerUI(folderName) {
            // A. Populate Season Dropdown
            const seasonSelect = document.getElementById('season-select');
            seasonSelect.innerHTML = "";
            
            // Populate with all available folders
            Object.keys(window.animeData).forEach(key => {
                let opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key; // e.g. JJK S1
                if(key === folderName) opt.selected = true;
                seasonSelect.appendChild(opt);
            });

            // B. Populate Episode Buttons (1, 2, 3...)
            renderEpisodeButtons(folderName);
        }

        function renderEpisodeButtons(folderName) {
            const container = document.getElementById('episode-pill-container');
            container.innerHTML = "";
            
            const episodes = window.animeData[folderName];
            
            episodes.forEach((ep, index) => {
                let btn = document.createElement('div');
                btn.className = 'ep-pill';
                btn.innerText = index + 1; // 1, 2, 3...
                btn.id = `ep-btn-${index}`;
                
                btn.onclick = function() {
                    let epId = ep.id ? ep.id : ep.title.replace(/[^a-zA-Z0-9]/g, '_');
                    playVideo(ep.title, ep.url, epId, ep.type === 'premium', index);
                };
                
                container.appendChild(btn);
            });
        }

        // Switch Season via Dropdown
        function switchSeason(newFolder) {
            openFolder(newFolder);
        }

        // --- MOVIE LOADING ---
        function loadMovies() {
            db.ref('movie_banners').on('value', s => {
                const c = document.getElementById('movie-banner-slider'); c.innerHTML = "";
                let i=0; s.forEach(b => { c.innerHTML += `<div class="slide ${i++===0?'active':''}" style="background-image:url('${b.val().image}')"></div>`; });
                startSlider('movie-banner-slider');
            });

            db.ref('movies').on('value', snap => {
                const grid = document.getElementById('movie-grid'); grid.innerHTML = "";
                snap.forEach(c => {
                    let d = c.val();
                    let safeId = d.id || d.title.replace(/[^a-zA-Z0-9]/g, '_');
                    
                    // Movies use index -1 (no pills)
                    grid.innerHTML += `
                        <div class="folder-card" onclick="playVideo('${d.title}', '${d.url}', '${safeId}', true, -1)">
                            <img src="${d.thumbnail}">
                            <div class="folder-info"><div class="folder-title">${d.title}</div></div>
                        </div>`;
                });
            });
        }

        function startSlider(id) {
            setInterval(() => {
                let p = document.getElementById(id), a = p.querySelector('.active');
                if(a) { a.classList.remove('active'); (a.nextElementSibling || p.querySelector('.slide')).classList.add('active'); }
            }, 4000);
        }

        // --- PLAYER & SOCIAL (UPDATED) ---
        function playVideo(title, url, id, isPrem, index) {
            if(isPrem && !isPremium) { alert("ROYAL VIP REQUIRED!"); switchTab('profile'); return; }
            
            // Clean listeners
            if(currentLikesCountRef) currentLikesCountRef.off();
            if(currentUserLikeRef) currentUserLikeRef.off();
            if(currentViewsRef) currentViewsRef.off();
            if(currentCommentsRef) currentCommentsRef.off();

            if(!id) id = title.replace(/[^a-zA-Z0-9]/g, '_');
            triggerSmartLink();

            currentVideoId = id;
            document.getElementById('player-title').innerText = title;
            
            // Update Active Pill State
            if(index !== -1) {
                document.querySelectorAll('.ep-pill').forEach(b => b.classList.remove('active'));
                let activeBtn = document.getElementById(`ep-btn-${index}`);
                if(activeBtn) activeBtn.classList.add('active');
            }

            const v = document.getElementById('main-video'); 
            v.src = url; 
            v.play();
            document.getElementById('player-view').style.display = 'block';
            
            // Save to Watchlist
            db.ref(`users/${currentUser.uid}/watchlist/${id}`).set({title: title, date: Date.now()});
            
            // View Count
            const viewRef = db.ref(`views/${id}`);
            viewRef.transaction(currentCount => {
                return (currentCount || 0) + 1;
            });

            loadSocialData(id);
        }

        function loadSocialData(id) {
            // 1. Listen for TOTAL LIKES
            currentLikesCountRef = db.ref(`likes/${id}/count`);
            currentLikesCountRef.on('value', snapshot => {
                document.getElementById('like-count').innerText = snapshot.val() || 0;
            });

            // 2. Listen for MY LIKE STATUS
            currentUserLikeRef = db.ref(`likes/${id}/${currentUser.uid}`);
            currentUserLikeRef.on('value', snapshot => {
                const btn = document.getElementById('like-btn');
                if (snapshot.exists()) {
                    btn.classList.add('liked');
                    btn.innerHTML = `<i class="fas fa-check"></i> Added`;
                } else {
                    btn.classList.remove('liked');
                    btn.innerHTML = `<i class="fas fa-plus"></i> Add to list`;
                }
            });

            // 3. Listen for VIEW COUNT
            currentViewsRef = db.ref(`views/${id}`);
            currentViewsRef.on('value', snapshot => {
                document.getElementById('view-count').innerText = snapshot.val() || 0;
            });

            // 4. Comments
            const list = document.getElementById('comments-list');
            list.innerHTML = "";
            currentCommentsRef = db.ref(`comments/${id}`);
            currentCommentsRef.on('child_added', s => {
                const c = s.val();
                list.innerHTML = `
                    <div class="comment-box">
                        <div class="c-avatar">${c.user[0]}</div>
                        <div class="c-body"><h4>${c.user}</h4><p>${c.text}</p></div>
                    </div>` + list.innerHTML;
            });
        }

        function toggleLike() {
            if(!currentVideoId || !currentUser) return;
            
            const userLikeRef = db.ref(`likes/${currentVideoId}/${currentUser.uid}`);
            const countRef = db.ref(`likes/${currentVideoId}/count`);

            userLikeRef.once('value', snapshot => {
                if (snapshot.exists()) {
                    // Unlike
                    userLikeRef.remove();
                    countRef.transaction(cnt => (cnt || 0) - 1);
                } else {
                    // Like
                    userLikeRef.set(true);
                    countRef.transaction(cnt => (cnt || 0) + 1);
                }
            });
        }

        function closePlayer() {
            const v = document.getElementById('main-video');
            v.pause();
            v.src = "";
            document.getElementById('player-view').style.display = 'none';

            if(currentLikesCountRef) currentLikesCountRef.off();
            if(currentUserLikeRef) currentUserLikeRef.off();
            if(currentViewsRef) currentViewsRef.off();
            if(currentCommentsRef) currentCommentsRef.off();
        }

        function postComment() {
            const txt = document.getElementById('comment-input').value;
            if(!txt) return;
            db.ref(`comments/${currentVideoId}`).push({
                user: currentUser.email.split('@')[0],
                text: txt,
                time: Date.now()
            });
            document.getElementById('comment-input').value = "";
        }

        function shareContent() {
            const link = `https://t.me/aminezone09`;
            navigator.clipboard.writeText(link).then(() => alert("Link Copied! Share on Telegram."));
        }

        // --- SHORTS SYSTEM ---
        let shortsObserver = null;
        let activeShortId = null;

        function showShorts() {
            document.getElementById('shorts-view').style.display = 'block';
            const con = document.getElementById('shorts-container');
            
            if(con.children.length === 0) {
                db.ref('shorts').once('value', s => {
                    s.forEach(c => {
                        let d = c.val();
                        let key = c.key;
                        con.innerHTML += `
                        <div class="short-item" data-id="${key}">
                            <video src="${d.url}" loop onclick="togglePlay(this)"></video>
                            <div class="short-overlay">
                                <div class="short-btn" id="s-like-${key}" onclick="toggleShortLike('${key}')">
                                    <i class="fas fa-heart"></i>
                                    <span id="s-like-cnt-${key}">0</span>
                                </div>
                                <div class="short-btn" onclick="openShortComments('${key}')">
                                    <i class="fas fa-comment"></i>
                                    <span>Comment</span>
                                </div>
                            </div>
                        </div>`;
                        loadShortLikes(key);
                    });
                    initShortsObserver();
                });
            } else {
                 initShortsObserver();
            }
        }

        function hideShorts() { 
            document.getElementById('shorts-view').style.display = 'none'; 
            document.querySelectorAll('#shorts-container video').forEach(v => {
                v.pause();
            });
        }
        
        function togglePlay(vid) {
            if(vid.paused) vid.play();
            else vid.pause();
        }

        function initShortsObserver() {
            let options = { root: document.getElementById('shorts-view'), threshold: 0.7 };
            shortsObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    let vid = entry.target.querySelector('video');
                    if(entry.isIntersecting) {
                        vid.play();
                    } else {
                        vid.pause();
                        vid.currentTime = 0;
                    }
                });
            }, options);

            document.querySelectorAll('.short-item').forEach(el => {
                shortsObserver.observe(el);
            });
        }

        function loadShortLikes(key) {
            db.ref(`shorts_likes/${key}`).on('value', s => {
                const d = s.val() || {};
                const cnt = d.count || 0;
                const btn = document.getElementById(`s-like-${key}`);
                const txt = document.getElementById(`s-like-cnt-${key}`);
                if(btn && txt) {
                    txt.innerText = cnt;
                    if(d[currentUser.uid]) btn.classList.add('liked');
                    else btn.classList.remove('liked');
                }
            });
        }

        function toggleShortLike(key) {
            if(!currentUser) return;
            const ref = db.ref(`shorts_likes/${key}`);
            ref.child(currentUser.uid).once('value', s => {
                if(s.exists()) {
                    ref.child(currentUser.uid).remove();
                    ref.child('count').transaction(c => (c||0)-1);
                } else {
                    ref.child(currentUser.uid).set(true);
                    ref.child('count').transaction(c => (c||0)+1);
                }
            });
        }

        function openShortComments(key) {
            activeShortId = key;
            document.getElementById('shorts-comments-modal').style.display = 'block';
            const list = document.getElementById('shorts-comments-list');
            list.innerHTML = "";
            db.ref(`shorts_comments/${key}`).on('child_added', s => {
                const c = s.val();
                 list.innerHTML = `
                    <div class="comment-box" style="padding:5px;">
                        <div class="c-avatar" style="width:25px;height:25px;font-size:10px;">${c.user[0]}</div>
                        <div class="c-body"><h4 style="font-size:11px;">${c.user}</h4><p style="font-size:10px;">${c.text}</p></div>
                    </div>` + list.innerHTML;
            });
        }

        function postShortComment() {
            if(!activeShortId) return;
            const txt = document.getElementById('short-comment-in').value;
            if(!txt) return;
            db.ref(`shorts_comments/${activeShortId}`).push({
                user: currentUser.email.split('@')[0], text: txt, time: Date.now()
            });
            document.getElementById('short-comment-in').value = "";
        }

        // --- HISTORY FUNCTIONS ---
        function openHistory() {
            document.getElementById('history-view').style.display = 'block';
            loadWatchlist(); // Load when opened
        }

        function closeHistory() {
            document.getElementById('history-view').style.display = 'none';
        }

        function loadWatchlist() {
            db.ref(`users/${currentUser.uid}/watchlist`).limitToLast(20).on('value', s => {
                const c = document.getElementById('history-list-container'); c.innerHTML = "";
                if(!s.exists()) { 
                    c.innerHTML = "<p style='color:#666; text-align:center; margin-top:20px;'>No history found.</p>"; 
                    return; 
                }
                
                // Show latest first
                let items = [];
                s.forEach(i => items.push(i));
                items.reverse().forEach(i => {
                    const data = i.val();
                    c.innerHTML += `
                    <div class="history-item">
                        <span style="color:#ddd; font-size:14px;">${data.title}</span>
                        <span style="color:#666; font-size:10px;">Watched</span>
                    </div>`;
                });
            });
        }

        // --- PREMIUM SYSTEM ---
        function redeemCode() {
            const code = document.getElementById('prem-code').value.trim();
            db.ref(`premium_codes/${code}`).once('value', s => {
                if(s.exists() && s.val().status === 'unused') {
                    const days = s.val().days || 30;
                    const expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
                    db.ref(`premium_codes/${code}`).update({status: 'used', usedBy: currentUser.email});
                    db.ref(`users/${currentUser.uid}`).update({premiumExpiry: expiry});
                    alert(`SUCCESS! ${days} Days VIP Added.`);
                    location.reload();
                } else alert("Invalid or Used Code.");
            });
        }

        function buyPremium() {
            const msg = `Hi Admin, I want to buy Premium.\nUID: ${currentUser.uid}\nEmail: ${currentUser.email}`;
            window.open(`https://t.me/aminezone09?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
