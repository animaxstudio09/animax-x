<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANIMAX PREMIUM</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "fdac3928-a2fc-4bc7-9541-cb85ae026409",
        });
      });
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { 
            --gold: #D4AF37; 
            --dark-gold: #AA8C2C;
            --black: #050505; 
            --glass: rgba(20, 20, 20, 0.95);
            --border: 1px solid rgba(212, 175, 55, 0.3);
            --neon-glow: 0 0 12px rgba(212, 175, 55, 0.4);
            --red: #ff3b3b;
            --green-accent: #00b894;
            --blue-btn: #1a1a1a; 
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Outfit', sans-serif; background: #000; color: #fff; overflow-x: hidden; padding-bottom: 70px; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- NEW AUTH SCREEN DESIGN (Anime Style + MotherPanel Layout) --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 10000;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), #000), url('https://w.wallhaven.cc/full/wq/wallhaven-wqve6r.jpg');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; 
            padding: 20px;
            overflow-y: auto;
        }

        .auth-navbar {
            display: flex; align-items: center; gap: 10px; margin-bottom: 40px;
        }
        .auth-brand { font-family: 'Orbitron'; font-size: 24px; font-weight: 900; color: #fff; letter-spacing: 1px; }
        .auth-brand span { color: var(--gold); }

        .auth-content {
            flex: 1;
            display: flex; flex-direction: column; justify-content: center;
            max-width: 450px; margin: 0 auto; width: 100%;
        }

        .auth-headline {
            font-size: 38px; font-weight: 800; line-height: 1.1; margin-bottom: 10px; color: #fff;
            font-family: 'Outfit', sans-serif; text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }
        .auth-headline span { color: var(--gold); }
        
        .auth-subhead {
            font-size: 14px; color: #ccc; margin-bottom: 30px; font-weight: 300;
            text-shadow: 0 1px 5px rgba(0,0,0,0.8);
        }

        .auth-card {
            background: rgba(20, 20, 20, 0.85); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 16px;
            padding: 25px; 
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { 
            display: block; font-size: 12px; color: var(--gold); margin-bottom: 8px; font-weight: 600; 
            font-family: 'Orbitron'; letter-spacing: 0.5px;
        }
        
        .custom-input { 
            width: 100%; padding: 14px 15px; border-radius: 8px; 
            border: 1px solid #333; background: rgba(0,0,0,0.5); color: #fff; 
            font-family: 'Outfit'; font-size: 14px; transition: 0.3s;
            text-align: left; 
        }
        .custom-input:focus { border-color: var(--gold); background: #000; box-shadow: var(--neon-glow); }

        .forgot-link {
            display: block; text-align: right; font-size: 11px; color: #888; 
            margin-top: 8px; cursor: pointer; font-weight: 400; transition: 0.2s;
        }
        .forgot-link:hover { color: #fff; }

        .btn-signin {
            width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: 700;
            background: linear-gradient(45deg, var(--dark-gold), var(--gold)); 
            color: #000; font-size: 15px; letter-spacing: 1px;
            font-family: 'Orbitron'; cursor: pointer; margin-top: 10px; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
        }
        .btn-signin:active { transform: scale(0.98); opacity: 0.9; }

        .auth-footer {
            margin-top: 25px; text-align: center; font-size: 13px; color: #888;
        }
        .auth-footer span { color: var(--gold); cursor: pointer; font-weight: 700; text-decoration: underline; }

        .floating-chat {
            position: fixed; bottom: 20px; right: 20px;
            width: 50px; height: 50px; background: linear-gradient(45deg, #0088cc, #005580); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #fff;
            font-size: 24px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); cursor: pointer; border: 1px solid rgba(255,255,255,0.2);
        }

        /* --- Main UI Structure (Existing) --- */
        .app-view { display: none; padding-top: 60px; animation: fadeIn 0.4s; }
        
        header { 
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(0,0,0,0.9); position: fixed; top: 0; left: 0; right: 0; z-index: 100; border-bottom: var(--border); 
            backdrop-filter: blur(10px);
        }
        .logo { font-family: 'Orbitron'; font-weight: 900; font-size: 20px; letter-spacing: 1px; }
        .logo span { color: var(--gold); }

        /* Slider */
        #banner-slider, #movie-banner-slider { 
            width: calc(100% - 30px); height: 180px; margin: 15px auto; border-radius: 15px; 
            overflow: hidden; position: relative; border: var(--border); box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .slide { position: absolute; inset: 0; opacity: 0; transition: 1s; background-size: cover; background-position: center; }
        .slide.active { opacity: 1; }

        /* Section Title */
        .section-title {
            padding: 0 15px; margin-top: 25px; margin-bottom: 15px;
            font-family: 'Orbitron'; color: var(--gold); letter-spacing: 1px; font-size: 14px; 
            display:flex; align-items:center; justify-content: space-between;
        }

        /* GRID 4 SYSTEM */
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 0 10px; }
        .folder-card { 
            position: relative; border-radius: 8px; overflow: hidden; background: #111; 
            border: 1px solid #222; aspect-ratio: 2/3; transition: 0.2s;
        }
        .folder-card:active { transform: scale(0.95); }
        .folder-card img { width: 100%; height: 100%; object-fit: cover; }
        .folder-info { 
            position: absolute; bottom: 0; width: 100%; padding: 5px; 
            background: linear-gradient(to top, #000 10%, transparent); text-align: center; 
        }
        .folder-title { font-size: 9px; font-family: 'Orbitron'; color: #fff; text-shadow: 0 1px 3px #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Movie Box Specifics --- */
        #movie-box-view { background: #0a0a0a; min-height: 100vh; }
        .movie-header { background: #1a0505; border-bottom: 1px solid #ff3b3b; }
        .movie-header .logo span { color: #ff3b3b; }
        
        /* --- Shorts --- */
        #shorts-view { 
            position: fixed; inset: 0; background: #000; z-index: 200; 
            padding: 0; overflow-y: scroll; scroll-snap-type: y mandatory; 
        }
        .short-item {
            width: 100%; height: 100vh; scroll-snap-align: start; position: relative;
            background: #111; display: flex; align-items: center; justify-content: center;
        }
        .short-item video { width: 100%; height: 100%; object-fit: cover; }
        .short-overlay {
            position: absolute; bottom: 80px; right: 10px; display: flex; flex-direction: column; gap: 20px; z-index: 10;
        }
        .short-btn { color: #fff; text-align: center; font-size: 24px; text-shadow: 0 2px 5px #000; cursor: pointer; }
        .short-btn.liked { color: var(--red); }
        .short-btn span { display: block; font-size: 10px; font-family: 'Orbitron'; margin-top: 5px; }

        /* Shorts Comment Modal */
        #shorts-comments-modal {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 60%;
            background: #111; border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 250; padding: 15px; border-top: 2px solid var(--gold);
            animation: slideUp 0.3s ease-out; box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- NEW PLAYER UI DESIGN --- */
        #player-view { 
            position: fixed; inset: 0; background: #000; z-index: 5000; overflow-y: auto; display: none; 
        }
        .video-wrapper { position: sticky; top: 0; z-index: 5001; background: #000; width: 100%; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; }

        /* Meta Container */
        .player-meta-container { padding: 15px; background: #050505; min-height: 100vh; }
        
        .meta-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .meta-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 5px; font-family: 'Outfit', sans-serif; line-height: 1.2; }
        
        .meta-info { font-size: 11px; color: #aaa; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .rating-star { color: #ffb400; font-size: 10px; }

        /* Action Buttons */
        .action-buttons-row { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .action-buttons-row::-webkit-scrollbar { display: none; }
        
        .act-btn { 
            background: #1e1e1e; color: #fff; border: 1px solid #333; 
            padding: 10px 16px; border-radius: 8px; font-size: 12px; 
            display: flex; align-items: center; gap: 6px; white-space: nowrap; cursor: pointer; transition: 0.2s;
        }
        .act-btn:active { transform: scale(0.95); background: #333; }
        .act-btn i { font-size: 14px; }
        .act-btn.liked { color: var(--red); border-color: var(--red); background: rgba(255, 59, 59, 0.1); }

        /* Resources / Season Dropdowns */
        .resources-section { margin-bottom: 25px; }
        .res-title { font-size: 13px; color: #fff; margin-bottom: 12px; font-weight: 600; }
        .res-title span { color: #888; font-size: 11px; font-weight: 400; margin-left: 5px; }
        
        .dropdown-row { display: flex; gap: 10px; margin-bottom: 15px; }
        
        select.custom-drop {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background: #1e1e1e; color: #ddd; border: 1px solid #333;
            padding: 8px 14px; padding-right: 30px; border-radius: 6px;
            font-size: 12px; cursor: pointer; outline: none;
        }
        .custom-drop-label {
            background: #1e1e1e; color: #ddd; border: 1px solid #333; 
            padding: 8px 14px; border-radius: 6px; font-size: 12px; 
            display: flex; align-items: center; gap: 8px; cursor: pointer;
        }

        /* Episode Pills */
        .ep-pill-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .ep-pill-row::-webkit-scrollbar { display: none; }
        
        .ep-pill { 
            min-width: 45px; height: 40px; background: #111; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 13px; color: #aaa; border: 1px solid #2a2a2a; flex-shrink: 0; cursor: pointer;
        }
        .ep-pill.active { background: var(--green-accent); color: #fff; border-color: var(--green-accent); font-weight: 700; box-shadow: 0 2px 10px rgba(0, 184, 148, 0.3); } 

        /* Tabs (For You / Comments) */
        .tab-header { display: flex; gap: 25px; border-bottom: 1px solid #222; margin-bottom: 20px; }
        .tab-item { padding-bottom: 10px; font-size: 14px; color: #888; position: relative; cursor: pointer; font-weight: 500; }
        .tab-item.active { color: #fff; font-weight: 700; }
        .tab-item.active::after { content:''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: #fff; }

        /* Vertical Recommendation Grid */
        .rec-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px; }
        .rec-card { position: relative; aspect-ratio: 2/3; border-radius: 8px; overflow: hidden; background: #111; cursor: pointer; }
        .rec-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .rec-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: #fff; font-size: 9px; padding: 2px 5px; border-radius: 4px; }
        .rec-title { position: absolute; bottom: 0; width: 100%; padding: 8px 5px; background: linear-gradient(to top, #000, transparent); font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }

        /* BuzzBox Preview at Bottom */
        .buzz-preview { background: #111; border-radius: 12px; padding: 15px; margin-top: 20px; border: 1px solid #222; cursor: pointer; }
        .buzz-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 12px; align-items: center; }
        .buzz-imgs { display: flex; gap: 8px; overflow: hidden; height: 90px; }
        .buzz-img { width: 32%; border-radius: 6px; object-fit: cover; opacity: 0.7; }
        .buzz-play { width: 32%; background:#1a1a1a; border-radius:6px; display:flex; align-items:center; justify-content:center; border:1px solid #333; }

        /* Comments in Player */
        .comment-section { padding: 0; margin-bottom: 50px; }
        .comment-box { display: flex; margin-bottom: 15px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #222; }
        .c-avatar { width: 30px; height: 30px; background: #333; border-radius: 50%; margin-right: 10px; color: var(--gold); display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .c-body h4 { font-size: 12px; color: var(--gold); margin-bottom: 3px; }
        .c-body p { font-size: 11px; color: #ccc; }

        /* --- Navigation --- */
        nav { 
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; 
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(15px); border-radius: 25px; 
            padding: 12px; display: flex; justify-content: space-around; border: 1px solid #333; z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        }
        nav i { font-size: 20px; color: #555; transition: 0.3s; padding: 10px; border-radius: 50%; }
        nav i.active { color: #000; background: var(--gold); box-shadow: var(--neon-glow); }

        /* --- Footer --- */
        .dev-footer {
            text-align: center; padding: 20px; margin-top: 30px; border-top: 1px solid #222;
            font-family: 'Orbitron'; font-size: 10px; color: #444;
        }
        
        /* AD Container */
        .ad-container-center {
            display: flex; justify-content: center; align-items: center;
            margin: 15px 0; overflow: hidden; width: 100%; min-height: 1px;
        }

        /* --- History Modal --- */
        #history-view {
            display:none; position:fixed; inset:0; background:#000; z-index:6000; overflow-y:auto; padding:20px;
            animation: fadeIn 0.3s;
        }
        .history-item {
            background: #111; padding: 15px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #222;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- ROYAL PROFILE STYLES --- */
        .profile-bg-header {
            background: linear-gradient(to bottom, #2c2000, #000);
            height: 180px;
            position: relative;
            border-bottom: 2px solid var(--gold);
            border-radius: 0 0 40px 40px;
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.3);
        }
        .royal-avatar-container {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: 110px;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(45deg, var(--gold), #fff, var(--gold));
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);
            z-index: 2;
        }
        .royal-avatar-img {
            width: 100%; height: 100%; border-radius: 50%; border: 3px solid #000; object-fit: cover; background: #000;
        }
        .royal-info-card { margin-top: 50px; text-align: center; padding: 0 20px; }
        .royal-badge {
            display: inline-block; padding: 5px 15px; background: linear-gradient(90deg, #000, #1a1a1a);
            border: 1px solid var(--gold); color: var(--gold); border-radius: 20px; font-size: 10px;
            font-family: 'Orbitron'; margin-top: 8px; box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
        }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .royal-menu-btn {
            background: rgba(255, 255, 255, 0.05); border: 1px solid #333; padding: 15px;
            border-radius: 15px; color: #ccc; display: flex; flex-direction: column;
            align-items: center; gap: 8px; font-size: 11px; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .royal-menu-btn:active { transform: scale(0.95); border-color: var(--gold); }
        .royal-menu-btn i { font-size: 20px; color: var(--gold); margin-bottom: 5px; }

        .telegram-card {
            background: linear-gradient(45deg, #0088cc, #005580); padding: 15px; margin: 0 20px 20px 20px;
            border-radius: 15px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 5px 20px rgba(0, 136, 204, 0.4); border: 1px solid rgba(255, 255, 255, 0.2); cursor: pointer;
        }
        .telegram-card:active { transform: scale(0.98); }
        
        /* Premium Area */
        .btn-royal {
            width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700;
            background: linear-gradient(45deg, var(--dark-gold), var(--gold)); color: #000;
            font-family: 'Orbitron'; cursor: pointer; letter-spacing: 1px; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .btn-royal:active { transform: scale(0.98); }

    </style>
</head>
<body>

    <!-- NEW LOGIN INTERFACE (Anime Styled) -->
    <div id="auth-screen">
        <div class="auth-navbar">
            <div class="auth-brand">ANIMAX <span>PREMIUM</span></div>
        </div>

        <div class="auth-content">
            <h1 class="auth-headline">Stream Your<br>Favorite <span>Anime</span><br>Anywhere</h1>
            <p class="auth-subhead">Join the world's largest anime community for free.</p>

            <div class="auth-card" id="login-form">
                <div class="input-group">
                    <label>EMAIL ADDRESS</label>
                    <input type="email" id="email-in" class="custom-input" placeholder="otaku@example.com">
                </div>
                <div class="input-group">
                    <label>PASSWORD</label>
                    <input type="password" id="pass-in" class="custom-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    <span class="forgot-link" onclick="alert('Contact Admin on Telegram')">Forgot password?</span>
                </div>

                <button class="btn-signin" onclick="handleAuth('login')">ENTER WORLD</button>

                <div class="auth-footer">
                    New here? <span onclick="toggleAuth()">Create Account</span>
                </div>
            </div>

            <div class="auth-card" id="reg-form" style="display:none;">
                <div class="input-group">
                    <label>VALID EMAIL</label>
                    <input type="email" id="remail-in" class="custom-input" placeholder="email@domain.com">
                </div>
                <div class="input-group">
                    <label>STRONG PASSWORD</label>
                    <input type="password" id="rpass-in" class="custom-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>

                <button class="btn-signin" onclick="handleAuth('reg')">REGISTER NOW</button>

                <div class="auth-footer">
                    Already a member? <span onclick="toggleAuth()">Login Now</span>
                </div>
            </div>
        </div>

        <div class="floating-chat" onclick="window.open('https://t.me/animax090', '_blank')">
            <i class="fab fa-telegram-plane"></i>
        </div>
    </div>

    <div id="main-app" class="app-view">
        <header>
            <div class="logo">ANIMAX <span>PREMIUM</span></div>
            <i class="fas fa-search" style="color:#fff; font-size:18px;"></i>
        </header>

        <div id="banner-slider"></div>

        <div id="ad-banner-top" class="ad-container-center"></div>
        
        <div class="section-title">
            <span><i class="fas fa-bolt" style="color:var(--gold)"></i> NEW RELEASE</span>
            <span style="font-size:10px; color:#666">See All</span>
        </div>

        <div id="anime-grid" class="grid-container"></div>

        <div class="dev-footer">Developed by RJ Rocky</div>
    </div>

    <div id="movie-box-view" class="app-view">
        <header class="movie-header">
            <div class="logo">MOVIE <span>BOX</span></div>
            <i class="fas fa-sign-out-alt" style="color:#fff;" onclick="switchInterface('main')"></i>
        </header>

        <div id="movie-banner-slider"></div>

        <div class="section-title">
            <span style="color:#ff3b3b"><i class="fas fa-film"></i> TRENDING MOVIES</span>
        </div>

        <!-- This grid will only show movies -->
        <div id="movie-grid" class="grid-container"></div>
    </div>

    <div id="shorts-view" style="display:none;">
        <div style="position:fixed; top:20px; left:20px; z-index:101; color:#fff;" onclick="hideShorts()">
            <i class="fas fa-arrow-left" style="background:rgba(0,0,0,0.5); padding:10px; border-radius:50%;"></i>
        </div>
        <div id="shorts-container"></div>
        
        <div id="shorts-comments-modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <span style="font-family:'Orbitron'; color:var(--gold);">COMMENTS</span>
                <i class="fas fa-times" onclick="document.getElementById('shorts-comments-modal').style.display='none'"></i>
            </div>
            <div id="shorts-comments-list" style="height: calc(100% - 100px); overflow-y:auto; margin-bottom:10px;"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="short-comment-in" placeholder="Write a comment..." style="margin-bottom:0;">
                <button class="btn-royal" style="width:50px; margin-top:0;" onclick="postShortComment()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="player-view">
        <div class="video-wrapper">
            <div style="position:absolute; top:15px; left:15px; z-index:10;" onclick="closePlayer()">
                <i class="fas fa-arrow-left" style="font-size:18px; color:#fff; background:rgba(0,0,0,0.6); padding:10px; border-radius:50%;"></i>
            </div>
            <video id="main-video" controls playsinline></video>
        </div>

        <div class="player-meta-container">
            
            <div class="meta-header">
                <div>
                    <div class="meta-title" id="player-title">Episode Title</div>
                    <div class="meta-info">
                        <i class="fas fa-tv"></i>
                        <span><i class="fas fa-star rating-star"></i> 8.5</span>
                        <span>| 2024</span>
                        <span>| Japan</span>
                        <span>| <span id="content-type-badge">Anime</span></span>
                        <span id="view-count" style="display:none">0</span>
                        <span id="like-count" style="display:none">0</span>
                    </div>
                </div>
                <i class="fas fa-chevron-right" style="color:#666; margin-top: 5px;"></i>
            </div>

            <div class="action-buttons-row">
                <div class="act-btn" id="like-btn" onclick="toggleLike()">
                    <i class="fas fa-plus"></i> Add to list
                </div>
                <div class="act-btn" onclick="shareContent()">
                    <i class="fas fa-share-alt"></i> Share
                </div>
                <div class="act-btn">
                    <i class="fas fa-download"></i> Download
                </div>
                <div class="act-btn" style="border:1px solid #444;">
                    <i class="fas fa-info-circle"></i> Details
                </div>
            </div>

            <div class="resources-section">
                <div class="res-title">Resources <span>Uploaded by Admin etc.</span> <i class="far fa-question-circle" style="font-size:10px; color:#666;"></i></div>
                <div class="dropdown-row">
                    <div class="custom-drop-label">Hindi dub <i class="fas fa-chevron-down"></i></div>
                    
                    <select id="season-select" onchange="switchSeason(this.value)" class="custom-drop">
                    </select>
                </div>

                <div class="ep-pill-row" id="episode-pill-container">
                </div>
            </div>

            <div class="tab-header">
                <div class="tab-item active" id="tab-btn-foryou" onclick="switchPlayerTab('foryou')">For you</div>
                <div class="tab-item" id="tab-btn-comments" onclick="switchPlayerTab('comments')">Comments</div>
            </div>

            <div id="tab-content-foryou">
                <div class="rec-grid" id="dynamic-rec-grid">
                    </div>
                
                <div class="buzz-preview" onclick="showShorts()">
                    <div class="buzz-header">
                        <span><b>BuzzBox</b> - Short & Funny</span>
                        <span style="color:var(--green-accent)">Explore ></span>
                    </div>
                    <div class="buzz-imgs">
                        <img src="https://via.placeholder.com/150/111/555?text=S1" class="buzz-img">
                        <img src="https://via.placeholder.com/150/111/555?text=S2" class="buzz-img">
                        <div class="buzz-play">
                            <i class="fas fa-play" style="color:#fff"></i>
                        </div>
                    </div>
                </div>

                <div id="ad-banner-player" class="ad-container-center" style="margin-top:20px;"></div>
            </div>

            <div id="tab-content-comments" style="display: none;">
                <div class="comment-section">
                    <div style="display:flex; gap:10px; margin-bottom:20px; margin-top:20px;">
                        <input type="text" id="comment-input" placeholder="Add a comment..." style="margin-bottom:0; background:#1e1e1e; border:none;">
                        <button class="btn-royal" style="width:60px; margin-top:0;" onclick="postComment()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                    <div id="comments-list"></div>
                </div>
            </div>

        </div>
    </div>

    <div id="profile-view" class="app-view" style="background:#050505; height:100vh; overflow-y:auto; padding-top:0;">
        
        <div class="profile-bg-header">
            <div style="position:absolute; top:20px; right:20px; color:var(--gold); font-size:20px;" onclick="auth.signOut()">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <div class="royal-avatar-container">
                <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="royal-avatar-img">
            </div>
        </div>

        <div class="royal-info-card">
            <h2 id="profile-name" style="font-family:'Orbitron'; font-size:22px; letter-spacing:1px; text-shadow:0 0 10px rgba(255,255,255,0.3);">USER</h2>
            <div id="vip-badge" class="royal-badge">FREE ACCOUNT</div>
        </div>

        <div style="margin-top: 25px;">
            <div class="telegram-card" onclick="window.open('https://t.me/animax090', '_blank')">
                <div style="display:flex; align-items:center; gap:15px;">
                    <i class="fab fa-telegram-plane" style="font-size:32px; color:#fff;"></i>
                    <div style="text-align:left;">
                        <h4 style="font-family:'Orbitron'; color:#fff; font-size:14px;">JOIN COMMUNITY</h4>
                        <p style="color:rgba(255,255,255,0.8); font-size:10px;">Official Updates & Requests</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right" style="color:#fff;"></i>
            </div>
        </div>

        <div class="menu-grid">
            <div class="royal-menu-btn" onclick="switchInterface('movie')">
                <i class="fas fa-film" style="color:#ff3b3b"></i>
                <span>Movie Box</span>
            </div>
            <div class="royal-menu-btn" onclick="openHistory()">
                <i class="fas fa-history"></i>
                <span>Watch History</span>
            </div>
            <div class="royal-menu-btn" onclick="alert('Locker Coming Soon!')">
                <i class="fas fa-lock"></i>
                <span>VIP Locker</span>
            </div>
            <div class="royal-menu-btn" onclick="document.querySelector('.premium-area').scrollIntoView({behavior:'smooth'})">
                <i class="fas fa-crown"></i>
                <span>Get Premium</span>
            </div>
        </div>

        <div class="premium-area" style="padding:20px; margin-bottom:80px;">
            <div style="background:linear-gradient(135deg, #1a1a1a, #000); border:1px solid var(--dark-gold); padding:20px; border-radius:15px; position:relative; overflow:hidden;">
                <div style="position:absolute; top:-20px; right:-20px; width:100px; height:100px; background:radial-gradient(circle, var(--gold) 0%, transparent 70%); opacity:0.2;"></div>
                
                <h4 style="color:var(--gold); font-family:'Orbitron'; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                    <i class="fas fa-gem"></i> REDEEM CODE
                </h4>
                
                <input type="text" id="prem-code" placeholder="Enter License Key" 
                       style="background:rgba(0,0,0,0.5); border:1px solid #444; color:#fff; width:100%; padding:12px; border-radius:8px; margin-bottom:10px;">
                
                <button class="btn-royal" onclick="redeemCode()" style="margin-top:0; font-size:12px;">ACTIVATE PREMIUM</button>
                
                <button onclick="buyPremium()" style="width:100%; background:transparent; border:1px solid #333; color:#888; padding:10px; margin-top:10px; border-radius:8px; font-size:11px;">
                    Purchase Subscription
                </button>
            </div>
        </div>
    </div>

    <div id="history-view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #333;">
            <h2 style="font-family:'Orbitron'; color:var(--gold);">WATCH HISTORY</h2>
            <i class="fas fa-times" style="font-size:24px; color:#fff;" onclick="closeHistory()"></i>
        </div>
        <div id="history-list-container"></div>
    </div>

    <nav id="main-nav">
        <i class="fas fa-home active" onclick="switchTab('home')"></i>
        <i class="fas fa-play-circle" onclick="showShorts()"></i>
        <i class="fas fa-user" onclick="switchTab('profile')"></i>
    </nav>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcWE5TCxamMSnJxqSm5X4mgSwSccIXcBI",
            authDomain: "myanimeapp-8d079.firebaseapp.com",
            databaseURL: "https://myanimeapp-8d079-default-rtdb.firebaseio.com",
            projectId: "myanimeapp-8d079",
            storageBucket: "myanimeapp-8d079.firebasestorage.app",
            messagingSenderId: "37482342893",
            appId: "1:37482342893:web:bebc7352e4bc102b725fe4"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database();

        let currentUser = null, isPremium = false, currentVideoId = null;
        let adSessionClick = false; 
        let adsLoaded = false;
        
        // Track if we are watching a movie or anime to show correct recommendations
        let isMovieContent = false; 

        // Listener References
        let currentLikesCountRef = null;
        let currentUserLikeRef = null;
        let currentViewsRef = null;
        let currentCommentsRef = null;

        // --- AUTH SYSTEM ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('profile-name').innerText = user.email.split('@')[0].toUpperCase();
                
                checkPremium(user.uid);
                loadContent();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
                currentUser = null;
            }
        });

        // --- AD SYSTEM ---
        function loadFreeUserAds() {
            if(adsLoaded) return; 
            adsLoaded = true;

            let s1 = document.createElement('script');
            s1.src = "https://pl28670634.effectivegatecpm.com/2f/28/1a/2f281ac58d64e6a580eb2d4171fe33d7.js";
            document.body.appendChild(s1);

            let s2 = document.createElement('script');
            s2.src = "https://pl28670723.effectivegatecpm.com/66/84/a1/6684a1bcf20a187f5844b6e689ba4482.js";
            document.body.appendChild(s2);

            const bannerTop = document.getElementById('ad-banner-top');
            if(bannerTop) {
                bannerTop.innerHTML = `
                    <iframe src="javascript:false" title="" scrolling="no" frameborder="0" 
                    style="border:none; width:320px; height:50px; overflow:hidden;" 
                    srcdoc='<script>atOptions = { "key" : "9f634c6894bc13ff8f0f19de1fcac9f3", "format" : "iframe", "height" : 50, "width" : 320, "params" : {} };<\/script><script src="https://www.highperformanceformat.com/9f634c6894bc13ff8f0f19de1fcac9f3/invoke.js"><\/script>'></iframe>
                `;
            }

            const bannerPlayer = document.getElementById('ad-banner-player');
            if(bannerPlayer) {
                bannerPlayer.innerHTML = `
                    <iframe src="javascript:false" title="" scrolling="no" frameborder="0" 
                    style="border:none; width:468px; height:60px; overflow:hidden;" 
                    srcdoc='<script>atOptions = { "key" : "3c0655cdf72da98fdd68dcdd704f9766", "format" : "iframe", "height" : 60, "width" : 468, "params" : {} };<\/script><script src="https://www.highperformanceformat.com/3c0655cdf72da98fdd68dcdd704f9766/invoke.js"><\/script>'></iframe>
                `;
            }
        }

        function triggerSmartLink() {
            if(isPremium) return;
            if(!adSessionClick) {
                window.open("https://www.effectivegatecpm.com/e3t9unhgv?key=2723dc497461b7507ba151e88ee0e871", "_blank");
                adSessionClick = true; 
            }
        }

        // --- PREMIUM CHECKER ---
        function checkPremium(uid) {
            db.ref(`users/${uid}`).on('value', s => {
                const d = s.val();
                if(d && d.premiumExpiry > Date.now()) {
                    isPremium = true;
                    document.getElementById('vip-badge').innerText = "ROYAL VIP MEMBER ðŸ‘‘";
                    document.getElementById('vip-badge').style.borderColor = "var(--gold)";
                    document.getElementById('vip-badge').style.color = "var(--gold)";
                    document.getElementById('ad-banner-top').style.display = 'none';
                    document.getElementById('ad-banner-player').style.display = 'none';
                } else {
                    isPremium = false;
                    document.getElementById('vip-badge').innerText = "FREE ACCOUNT";
                    document.getElementById('vip-badge').style.borderColor = "#333";
                    document.getElementById('vip-badge').style.color = "#666";
                    document.getElementById('ad-banner-top').style.display = 'flex';
                    document.getElementById('ad-banner-player').style.display = 'flex';
                    loadFreeUserAds();
                }
            });
        }

        function handleAuth(type) {
            const e = document.getElementById(type === 'login' ? 'email-in' : 'remail-in').value;
            const p = document.getElementById(type === 'login' ? 'pass-in' : 'rpass-in').value;
            if (type === 'login') auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
            else auth.createUserWithEmailAndPassword(e, p).catch(err => alert(err.message));
        }
        function toggleAuth() {
            const l = document.getElementById('login-form'), r = document.getElementById('reg-form');
            l.style.display = l.style.display === 'none' ? 'block' : 'none';
            r.style.display = r.style.display === 'none' ? 'block' : 'none';
        }

        // --- NAVIGATION & UI ---
        function switchTab(tab) {
            document.querySelectorAll('.app-view').forEach(d => d.style.display = 'none');
            hideShorts();
            
            if (tab === 'home') document.getElementById('main-app').style.display = 'block';
            if (tab === 'profile') document.getElementById('profile-view').style.display = 'block';
            
            document.querySelectorAll('nav i').forEach(i => i.classList.remove('active'));
            if(tab === 'home') document.querySelector('.fa-home').classList.add('active');
            if(tab === 'profile') document.querySelector('.fa-user').classList.add('active');
        }

        function switchInterface(to) {
            document.querySelectorAll('.app-view').forEach(d => d.style.display = 'none');
            if(to === 'movie') {
                document.getElementById('movie-box-view').style.display = 'block';
                document.getElementById('main-nav').style.display = 'none';
                loadMovies();
            } else {
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('main-nav').style.display = 'flex';
            }
        }

        // --- DATA LOADING (ANIME - MERGING SAME NAMES) ---
        function loadContent() {
            db.ref('banners').on('value', s => {
                const c = document.getElementById('banner-slider'); c.innerHTML = "";
                let i=0; s.forEach(b => { c.innerHTML += `<div class="slide ${i++===0?'active':''}" style="background-image:url('${b.val().image}')"></div>`; });
                startSlider('banner-slider');
            });

            db.ref('anime').on('value', snap => {
                const grid = document.getElementById('anime-grid'); grid.innerHTML = "";
                let folders = {};
                snap.forEach(c => {
                    let d = c.val();
                    let rawFolder = d.folder || 'Misc';
                    // FIX: .trim() removes extra spaces, merging "Name " and "Name" into one
                    let f = rawFolder.trim(); 
                    
                    if(!folders[f]) folders[f] = [];
                    folders[f].push(d);
                });
                
                Object.keys(folders).forEach(name => {
                    let thumb = folders[name][0].thumbnail;
                    grid.innerHTML += `
                        <div class="folder-card" onclick="openFolder('${name.replace(/'/g, "\\'")}')">
                            <img src="${thumb}">
                            <div class="folder-info"><div class="folder-title">${name}</div></div>
                        </div>`;
                });
                window.animeData = folders;
            });
        }

        function openFolder(name) {
            currentFolder = name;
            const episodes = window.animeData[name];
            
            if(!episodes || episodes.length === 0) return;

            const firstEp = episodes[0];
            let epId = firstEp.id ? firstEp.id : firstEp.title.replace(/[^a-zA-Z0-9]/g, '_');
            
            playVideo(firstEp.title, firstEp.url, epId, firstEp.type === 'premium', 0);
            loadPlayerUI(name);
        }

        function loadPlayerUI(folderName) {
            const seasonSelect = document.getElementById('season-select');
            seasonSelect.innerHTML = "";
            
            Object.keys(window.animeData).forEach(key => {
                let opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key; 
                if(key === folderName) opt.selected = true;
                seasonSelect.appendChild(opt);
            });

            renderEpisodeButtons(folderName);
        }

        function renderEpisodeButtons(folderName) {
            const container = document.getElementById('episode-pill-container');
            container.innerHTML = "";
            
            const episodes = window.animeData[folderName];
            
            episodes.forEach((ep, index) => {
                let btn = document.createElement('div');
                btn.className = 'ep-pill';
                btn.innerText = index + 1;
                btn.id = `ep-btn-${index}`;
                
                btn.onclick = function() {
                    let epId = ep.id ? ep.id : ep.title.replace(/[^a-zA-Z0-9]/g, '_');
                    playVideo(ep.title, ep.url, epId, ep.type === 'premium', index);
                };
                
                container.appendChild(btn);
            });
        }

        function switchSeason(newFolder) {
            openFolder(newFolder);
        }

        // --- MOVIE LOADING ---
        function loadMovies() {
            db.ref('movie_banners').on('value', s => {
                const c = document.getElementById('movie-banner-slider'); c.innerHTML = "";
                let i=0; s.forEach(b => { c.innerHTML += `<div class="slide ${i++===0?'active':''}" style="background-image:url('${b.val().image}')"></div>`; });
                startSlider('movie-banner-slider');
            });

            // Added window.movieData to store movies for recommendations
            db.ref('movies').on('value', snap => {
                const grid = document.getElementById('movie-grid'); grid.innerHTML = "";
                window.movieData = []; // Clear previous data
                
                snap.forEach(c => {
                    let d = c.val();
                    let safeId = d.id || d.title.replace(/[^a-zA-Z0-9]/g, '_');
                    
                    window.movieData.push(d); // Store for recommendation use
                    
                    grid.innerHTML += `
                        <div class="folder-card" onclick="playVideo('${d.title}', '${d.url}', '${safeId}', true, -1)">
                            <img src="${d.thumbnail}">
                            <div class="folder-info"><div class="folder-title">${d.title}</div></div>
                        </div>`;
                });
            });
        }

        function startSlider(id) {
            setInterval(() => {
                let p = document.getElementById(id), a = p.querySelector('.active');
                if(a) { a.classList.remove('active'); (a.nextElementSibling || p.querySelector('.slide')).classList.add('active'); }
            }, 4000);
        }

        // --- PLAYER & SOCIAL ---
        function playVideo(title, url, id, isPrem, index) {
            if(isPrem && !isPremium) { alert("ROYAL VIP REQUIRED!"); switchTab('profile'); return; }
            
            if(currentLikesCountRef) currentLikesCountRef.off();
            if(currentUserLikeRef) currentUserLikeRef.off();
            if(currentViewsRef) currentViewsRef.off();
            if(currentCommentsRef) currentCommentsRef.off();

            if(!id) id = title.replace(/[^a-zA-Z0-9]/g, '_');
            triggerSmartLink();

            currentVideoId = id;
            document.getElementById('player-title').innerText = title;
            
            // Determine content type for UI and Recommendations
            if(index === -1) {
                // It is a movie
                isMovieContent = true;
                document.getElementById('content-type-badge').innerText = "Movie";
                document.getElementById('episode-pill-container').style.display = 'none'; // Hide episode pills for movie
                document.querySelector('.dropdown-row').style.display = 'none'; // Hide season dropdown for movie
            } else {
                // It is anime
                isMovieContent = false;
                document.getElementById('content-type-badge').innerText = "Anime";
                document.getElementById('episode-pill-container').style.display = 'flex';
                document.querySelector('.dropdown-row').style.display = 'flex';
                
                document.querySelectorAll('.ep-pill').forEach(b => b.classList.remove('active'));
                let activeBtn = document.getElementById(`ep-btn-${index}`);
                if(activeBtn) activeBtn.classList.add('active');
            }

            const v = document.getElementById('main-video'); 
            v.src = url; 
            v.play();
            document.getElementById('player-view').style.display = 'block';

            // New Tabs functionality triggers here
            switchPlayerTab('foryou');
            loadForYouVideos();
            
            db.ref(`users/${currentUser.uid}/watchlist/${id}`).set({title: title, date: Date.now()});
            
            const viewRef = db.ref(`views/${id}`);
            viewRef.transaction(currentCount => {
                return (currentCount || 0) + 1;
            });

            loadSocialData(id);
        }

        function loadSocialData(id) {
            currentLikesCountRef = db.ref(`likes/${id}/count`);
            currentLikesCountRef.on('value', snapshot => {
                document.getElementById('like-count').innerText = snapshot.val() || 0;
            });

            currentUserLikeRef = db.ref(`likes/${id}/${currentUser.uid}`);
            currentUserLikeRef.on('value', snapshot => {
                const btn = document.getElementById('like-btn');
                if (snapshot.exists()) {
                    btn.classList.add('liked');
                    btn.innerHTML = `<i class="fas fa-check"></i> Added`;
                } else {
                    btn.classList.remove('liked');
                    btn.innerHTML = `<i class="fas fa-plus"></i> Add to list`;
                }
            });

            currentViewsRef = db.ref(`views/${id}`);
            currentViewsRef.on('value', snapshot => {
                document.getElementById('view-count').innerText = snapshot.val() || 0;
            });

            const list = document.getElementById('comments-list');
            list.innerHTML = "";
            currentCommentsRef = db.ref(`comments/${id}`);

            // Update Comments Count on the Tab button
            currentCommentsRef.on('value', snap => {
                let count = snap.numChildren();
                document.getElementById('tab-btn-comments').innerText = `Comments (${count})`;
            });

            currentCommentsRef.on('child_added', s => {
                const c = s.val();
                list.innerHTML = `
                    <div class="comment-box">
                        <div class="c-avatar">${c.user[0]}</div>
                        <div class="c-body"><h4>${c.user}</h4><p>${c.text}</p></div>
                    </div>` + list.innerHTML;
            });
        }

        function toggleLike() {
            if(!currentVideoId || !currentUser) return;
            
            const userLikeRef = db.ref(`likes/${currentVideoId}/${currentUser.uid}`);
            const countRef = db.ref(`likes/${currentVideoId}/count`);

            userLikeRef.once('value', snapshot => {
                if (snapshot.exists()) {
                    userLikeRef.remove();
                    countRef.transaction(cnt => (cnt || 0) - 1);
                } else {
                    userLikeRef.set(true);
                    countRef.transaction(cnt => (cnt || 0) + 1);
                }
            });
        }

        function closePlayer() {
            const v = document.getElementById('main-video');
            v.pause();
            v.src = "";
            document.getElementById('player-view').style.display = 'none';

            if(currentLikesCountRef) currentLikesCountRef.off();
            if(currentUserLikeRef) currentUserLikeRef.off();
            if(currentViewsRef) currentViewsRef.off();
            if(currentCommentsRef) currentCommentsRef.off();
        }

        function postComment() {
            const txt = document.getElementById('comment-input').value;
            if(!txt) return;
            db.ref(`comments/${currentVideoId}`).push({
                user: currentUser.email.split('@')[0],
                text: txt,
                time: Date.now()
            });
            document.getElementById('comment-input').value = "";
        }

        function shareContent() {
            const link = `https://t.me/aminezone09`;
            navigator.clipboard.writeText(link).then(() => alert("Link Copied! Share on Telegram."));
        }

        // --- NEW TAB SYSTEM FOR PLAYER ---
        function switchPlayerTab(tab) {
            if(tab === 'foryou') {
                document.getElementById('tab-btn-foryou').classList.add('active');
                document.getElementById('tab-btn-comments').classList.remove('active');
                document.getElementById('tab-content-foryou').style.display = 'block';
                document.getElementById('tab-content-comments').style.display = 'none';
            } else {
                document.getElementById('tab-btn-comments').classList.add('active');
                document.getElementById('tab-btn-foryou').classList.remove('active');
                document.getElementById('tab-content-comments').style.display = 'block';
                document.getElementById('tab-content-foryou').style.display = 'none';
            }
        }

        // --- DYNAMIC 'FOR YOU' VIDEOS ---
        function loadForYouVideos() {
            const grid = document.getElementById('dynamic-rec-grid');
            grid.innerHTML = "";
            
            // STRICT SEPARATION: If watching a movie, show movies. If anime, show anime.
            if(isMovieContent) {
                // Load MOVIE recommendations
                if(!window.movieData) return;
                window.movieData.forEach(m => {
                    let safeId = m.id || m.title.replace(/[^a-zA-Z0-9]/g, '_');
                    grid.innerHTML += `
                        <div class="rec-card" onclick="playVideo('${m.title}', '${m.url}', '${safeId}', true, -1)">
                            <img src="${m.thumbnail}">
                            <div class="rec-badge">Movie</div>
                            <div class="rec-title">${m.title}</div>
                        </div>
                    `;
                });
            } else {
                // Load ANIME recommendations (Existing Logic)
                if(!window.animeData) return;
                Object.keys(window.animeData).forEach(folderName => {
                    let firstEp = window.animeData[folderName][0]; 
                    let safeName = folderName.replace(/'/g, "\\'");
                    
                    grid.innerHTML += `
                        <div class="rec-card" onclick="openFolder('${safeName}')">
                            <img src="${firstEp.thumbnail}">
                            <div class="rec-badge">${firstEp.type === 'premium' ? 'VIP' : 'Free'}</div>
                            <div class="rec-title">${folderName}</div>
                        </div>
                    `;
                });
            }
        }

        // --- SHORTS SYSTEM ---
        let shortsObserver = null;
        let activeShortId = null;

        function showShorts() {
            document.getElementById('shorts-view').style.display = 'block';
            const con = document.getElementById('shorts-container');
            
            if(con.children.length === 0) {
                db.ref('shorts').once('value', s => {
                    s.forEach(c => {
                        let d = c.val();
                        let key = c.key;
                        con.innerHTML += `
                        <div class="short-item" data-id="${key}">
                            <video src="${d.url}" loop onclick="togglePlay(this)"></video>
                            <div class="short-overlay">
                                <div class="short-btn" id="s-like-${key}" onclick="toggleShortLike('${key}')">
                                    <i class="fas fa-heart"></i>
                                    <span id="s-like-cnt-${key}">0</span>
                                </div>
                                <div class="short-btn" onclick="openShortComments('${key}')">
                                    <i class="fas fa-comment"></i>
                                    <span>Comment</span>
                                </div>
                            </div>
                        </div>`;
                        loadShortLikes(key);
                    });
                    initShortsObserver();
                });
            } else {
                 initShortsObserver();
            }
        }

        function hideShorts() { 
            document.getElementById('shorts-view').style.display = 'none'; 
            document.querySelectorAll('#shorts-container video').forEach(v => {
                v.pause();
            });
        }
        
        function togglePlay(vid) {
            if(vid.paused) vid.play();
            else vid.pause();
        }

        function initShortsObserver() {
            let options = { root: document.getElementById('shorts-view'), threshold: 0.7 };
            shortsObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    let vid = entry.target.querySelector('video');
                    if(entry.isIntersecting) {
                        vid.play();
                    } else {
                        vid.pause();
                        vid.currentTime = 0;
                    }
                });
            }, options);

            document.querySelectorAll('.short-item').forEach(el => {
                shortsObserver.observe(el);
            });
        }

        function loadShortLikes(key) {
            db.ref(`shorts_likes/${key}`).on('value', s => {
                const d = s.val() || {};
                const cnt = d.count || 0;
                const btn = document.getElementById(`s-like-${key}`);
                const txt = document.getElementById(`s-like-cnt-${key}`);
                if(btn && txt) {
                    txt.innerText = cnt;
                    if(d[currentUser.uid]) btn.classList.add('liked');
                    else btn.classList.remove('liked');
                }
            });
        }

        function toggleShortLike(key) {
            if(!currentUser) return;
            const ref = db.ref(`shorts_likes/${key}`);
            ref.child(currentUser.uid).once('value', s => {
                if(s.exists()) {
                    ref.child(currentUser.uid).remove();
                    ref.child('count').transaction(c => (c||0)-1);
                } else {
                    ref.child(currentUser.uid).set(true);
                    ref.child('count').transaction(c => (c||0)+1);
                }
            });
        }

        function openShortComments(key) {
            activeShortId = key;
            document.getElementById('shorts-comments-modal').style.display = 'block';
            const list = document.getElementById('shorts-comments-list');
            list.innerHTML = "";
            db.ref(`shorts_comments/${key}`).on('child_added', s => {
                const c = s.val();
                 list.innerHTML = `
                    <div class="comment-box" style="padding:5px;">
                        <div class="c-avatar" style="width:25px;height:25px;font-size:10px;">${c.user[0]}</div>
                        <div class="c-body"><h4 style="font-size:11px;">${c.user}</h4><p style="font-size:10px;">${c.text}</p></div>
                    </div>` + list.innerHTML;
            });
        }

        function postShortComment() {
            if(!activeShortId) return;
            const txt = document.getElementById('short-comment-in').value;
            if(!txt) return;
            db.ref(`shorts_comments/${activeShortId}`).push({
                user: currentUser.email.split('@')[0], text: txt, time: Date.now()
            });
            document.getElementById('short-comment-in').value = "";
        }

        // --- HISTORY FUNCTIONS ---
        function openHistory() {
            document.getElementById('history-view').style.display = 'block';
            loadWatchlist();
        }

        function closeHistory() {
            document.getElementById('history-view').style.display = 'none';
        }

        function loadWatchlist() {
            db.ref(`users/${currentUser.uid}/watchlist`).limitToLast(20).on('value', s => {
                const c = document.getElementById('history-list-container'); c.innerHTML = "";
                if(!s.exists()) { 
                    c.innerHTML = "<p style='color:#666; text-align:center; margin-top:20px;'>No history found.</p>"; 
                    return; 
                }
                
                let items = [];
                s.forEach(i => items.push(i));
                items.reverse().forEach(i => {
                    const data = i.val();
                    c.innerHTML += `
                    <div class="history-item">
                        <span style="color:#ddd; font-size:14px;">${data.title}</span>
                        <span style="color:#666; font-size:10px;">Watched</span>
                    </div>`;
                });
            });
        }

        // --- PREMIUM SYSTEM ---
        function redeemCode() {
            const code = document.getElementById('prem-code').value.trim();
            db.ref(`premium_codes/${code}`).once('value', s => {
                if(s.exists() && s.val().status === 'unused') {
                    const days = s.val().days || 30;
                    const expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
                    db.ref(`premium_codes/${code}`).update({status: 'used', usedBy: currentUser.email});
                    db.ref(`users/${currentUser.uid}`).update({premiumExpiry: expiry});
                    alert(`SUCCESS! ${days} Days VIP Added.`);
                    location.reload();
                } else alert("Invalid or Used Code.");
            });
        }

        function buyPremium() {
            const msg = `Hi Admin, I want to buy Premium.\nUID: ${currentUser.uid}\nEmail: ${currentUser.email}`;
            window.open(`https://t.me/aminezone09?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
